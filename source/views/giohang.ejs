<!DOCTYPE html>
<html>
<%- include("./partials/head.ejs") %>
<link rel="stylesheet" href="/css/style_giohang.css" />
    <body>
        scroll-padding-top: 123px;
        <div class="desktop"><div class="div"></div></div>
        <!-- toolbar -->
        <%- include("./partials/toolbar.ejs") %>

        <!--  -->
        <div class="cart">
            <h1>Giỏ hàng</h1>
            <% if (err == 'No Mail') {%>
                <div class="cart-ui-content">
                    <div class="cart-emty">
                        <div class="icon-emty">
                            <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAh1BMVEX///8AAADc3Nzl5eX09PSysrJhYWF0dHTHx8fZ2dnv7+/Pz8/7+/vq6up9fX339/dJSUmDg4OioqIgICBPT0/Nzc1sbGxDQ0PFxcWLi4vh4eGsrKxXV1cXFxdnZ2cWFhYlJSU0NDSZmZk9PT28vLwNDQ0sLCylpaWRkZEkJCSbm5s2NjaIiIiFSkK7AAAOOUlEQVR4nO1d6VryOhCWHVp2UVBQQKjgcv/Xd0RlZtJmmWxtv/P4/tSSZprMZPbc3NQUw8mgM591l7tt1mhk292yO5530smw6nmFQXswv39tSLF7PqdJ1fPzRKvzfCun7ort5vRY9Syd0V5P9dRdsZ//kyuZ9njk/aC7+teY8shcPrKQ60nVk7ZARyFa9Lh9r3reXKwMwkWDTtVz56C5cabvC4e7qudvxINq7ttpb3aerzud9fw86y2U6zyuNzsO5Ay4mffbOVk5nKQnubR9WlUzdxbOkgkv5wP1D1rrhWwZy5uxHdrFE2I5b5l+NZIQeainmpMWWOs+5f2yOS7QWMed2instRH/x+3C/q7f2fjiQd8F7bwQrhsz5ua30EgXFVr3uT0efpYeyDGSo2qyEkfpyp9qpwR3/f7dYBRfaxcPtk070EAyEpPcSv/gtXcyCm0ffApvm/sMdTRs1Ilap1/EU2rn9D0Z84RQoSWQUBA3Mp0CcBuJRuGzH9x36C+GguaePzTedBQ2Gh8OEs6IAX2DQjjYYUZHzB39egK/cAoxAwGTLRm+F2ZMYSuKCtzeSGKgOSA2MQan6sNB+M88T1ARm1CzKL7xOdywdBVFaSOzRXIIwipXDGINTHlRYMXhQ2Yk8SHgRD5w2GlYxYLs/ifR6h+2cxj133N22zHYNN7JqIGdukNyLjKU8ERUjL3PrF+0yJjBDyI6OEeLaMWQec84ZARzjmgSS9YP6DKG0VL7OGBgCf0DomPz1DEigcOYXoS9Lc1dJsia8H7QCzsjYs2FV5W+QTYJz2AZ7oNOCYXdwfywG5DRb3l+YuTdAHxzhx/Y02BSg8jTNe8XuIj+pxeqTyqu7j/MWBGzzuen6ohG8fjBm9UafuAdACH6mtx9O1nwXtT8drMe5JKhjW/ps6aVwPMvrOc1QMVRcbp2eTO7fikFL+MBwFR7M8O02Gijg1uuzeAaa1exCY/JNypZRB5jwYHxxHpcDaPQIiqrZhWRQJVBgH5K3oGB7/XUTVHfUEQYqBGrJJEaX5/yR/Ab8GTNnfmtLAxxZoonUjJ51UYdUFNPpZih5sQKSKGo8fJqkk16Vj0imGxSEpv0iVvVOCj/WUfi8HB93M8iR+5oqh5JhGCbZMsIBKrHGcEjPDUF+CdjPa4CvFWjsI30JApeSJ15CarFliVNUQD4KN+oTc00T42eNBuVuYJfOHE+AwIFgI+oQTbUqqSajcon8OYRHmOpKfj1faxyYEPDxkmEVSQksrfoBfAcz125vz7uI2qW10GmhgcVvCgcE8bNBzbUjuXOu6qLXGVdhgnER3Rs+A0pL1ps0QuQEVlGIjqp3Z01JmWSQsKLlgQS2cEyRPt2jxteyZBuBV604sELUPtmOaRCGFCYWMLRbkVeTB8FHjSv4JeaAt+Ip4jB4O4ON7S8WY+LJFoTSM58XgYKSKY963EZwAZjSqtElYjIdJTD+3jyH0VN14h7uSQB1Y/r0BrJSeRGAsCfwPN996UvU2EhGwIiBGxPgXho/IK3RW+IK2PHenxiRaF0YwBfKE2nAiQblU0gbrst7/mdHYmSYxNMPwtxnORX0SJYBSYi0yCyqoOQeSnQyLQxo5M9HTXjryA9nXjPixlMpVH4uBWGtdE3bCkUE6uMkNiRLru0mR/XwnoDxZS5S1v5d2kh061B0vBTAgbFkfkkgqRh+kDbNqJGqviAfcI+LQoreAE7sgCnxSvzBzDBrGfAi1zgWZ/4UgL5qwgnvskcLfyA54EsAqQxU/FTEMgm0VJro1qNo68GwyWsxwWLPtvbkwiSzWhwX9/YsP1FDii9Of69nMGb6DxwUgzhnGGfTuCEcAwF4ydinGoFi97oKs7D0gK+AE7snVt85tHilRKLXumBU6Av/pwDdAu7+WqGcN4YTVKpV000powbFe09dlkbajWOKW7A+iaDTeF0siMRjDXucUiDHY6iBlVbfWxAJJDsMStehOcs/C7wG8ekV9wE2gosjVfNELaRj2Kh6GNszy0pFDeBjhG1flFt2EYAsqGFSYmixjGvBqb3qv5EBscve6NCCOHNQvLjke1Yg4GMqDwRHykBss/PPPpxHJtIi7dbGI8olaxCM1m5v0ReVJ0EuEltVgO9UY5Jd+ZMBcGlp3BZCLyoitLDJrWL6WKyiM2vCDCQr/iyNNuEFetXbAaMkXBNpx94G1C4RIpDnxRiaEQg4UWFZxLXgpmdWJigo1ZDUunlsgYlqdarhrwol6Z4LvFVtm+ggOI7dUUYU+quZqvBbXglUepcp9xgmYmHhYq8UEARxJ+lODC+STRX1iff6kdXvkIj41uUAHcZX5vNAbw9SiuzOX/pc3Sm9P1dxarovbaTMzf0yHYtBSFKp1+OHO8d1vJi5T89PKiYARN7YKa1fbATv45zZT/JPnQVVwaQNg0O2iX81j2vhhQa2cRZ2CD5wcrMRQ1AbXxyzqUlXBKl4oJ8QZdGIJgt7J7CR+J0js4CHYhW5OQTxD3uXo6IJkrIosZf0CRjJybA2XmIiTWZReCuDW0SbnScod8W+AWpO74NW0RKzEtXpQR1Eo950FjkMmQhcJcM7KqTYGKTz8ennYUUyrMLaK6Bc3YaegS9+mXQZirB6tUpge7fDUWNXw0v7UWyCLNRSX1x49a99AUrlzxyaW8EA+eLFwOImyHlQa8a8SCi5kYotfz65N6d1pIlHc/rmEXz2bOWXuxj5nn0C9VEngyE3963/dtJmJWXAvcuDKWo9uJiEGqgfLO2g7Ol0RI7g3q3bAMp6H+Q5frROTYXEfdCgNYPwNKv/i1Dc5PLHDZ+ehDHCNCDBR2CAVpN5tsmbix9Y4/5Pmx+5YM/YMY5mbjLzbDRtaBxUOgzF8QaQ7dwEPt19JGf5ZKpD64KrYe3gZrBwICBOjxJGv7NUpMi15R0Hu6GMlNQewjUnbjQw/QLu/FR6ScZpbPCwjfCsOAPvIPdBbTkrbiW407+EoQkPc6m0qZWIfvmeQe7JVjLJv2D/ab38DKfvzz0NrKV+0XQbkXokAzo0k2KTYEt0A3r7sFYtXXcQ4eBc1f2afCO7Ghqhh03tb4Z4YJ9cI8kDXaH7uA6eNaQUtL6XYARqPCfr/VicQXE7SxG49Eb6gz07lcjwbDPFDr3x2i3BbThM0dqZjXsP8iq1giyWdz7V0DquYSvmEhWn1NpicfbdHyM2sH5AhQ1kfjgF8PHQefcu+8upofDdNG97z100mYpF1l4FyZYY1jynUABgt11B7iFo/R2rAN8CxPqD/RPRpdqFSFEsLvewLiKt1u4rgAKA3bjrhfQ7VD1TGIhvK+mbojhq6kXQgW7vdDpLs5xmi1/YQIevWjdgE1IXuMeV7F8NXxc9apYV5ExWiDGBYR0Yin/3oUJvgBpHjDjSAAWRoS8FsIC4HmMZd5gbUhQtzAf8IWD3xBzBXxDTS1hRGAUM1LveprCV4moQZ9tNFdRgMIEH8AHzqKd+ShqKvHVgEMzosYBFFZhQKGgi3jfIfhqsgp8NTYdKJyBvpoKDCiUAtHukKjYV4OSPOJZFSXYzQUo/mEjJ7lrr4DCTeE+rNjAKtmAGs3g5XlvvrusdNgVMmvQdwqxl4BAgqbdNb+qIoQRNI813J2/CKPRPJpfVBmCaIyau3SrR5BsPeltyHVBCMMiNb+mOgTRNZyzzUpAEG80LWndnDp5rOfzdeGPJeEYxqYh+btRMsiqB9b0hcjMryMgqTuW47Vy7K8U/m/D2UBhRa7t+ABvzP82NwijaHGT9KoDlgk8VRRGiw3aHGC2atYcTtFSoYK49pg68JLd1R3Vw4HE+nowpHDoszaqrw9DCgeTsdYWYhEu3rd/i0SnKEqrrt5SCVx1r7XqdqnawT1puT/emoevHF1P11TSqjn8yPvDH/7whz/84Q8MDPrr9/dOP6jHqnV3PL2cjmkNSuT6XTAjs+dAKUStBwzOLueVlq4MT3mdNUBaa5qP6/WqU8ru9kUVeO+ZddqWhZ4rSL76xlkyl4ZnoCOV1+OHaLBoD6WnyiPvVNZ16BtWF5EGgsYV50yi7kbQWCUySsw0k3FtBqb1C21L6TiAMNy/6nRsTPQek2Ata1loiy/fvr7mjg2XtLPczcO71xzFpVY80j2afQ6+NI/24JN6kB32qXApWXfVurTHWNPoyVuJ+5Qu4T0I8oQ2CrIX7+TXt5j+QZuBBcspNYP0sBeC4OSEtE7qIQk8H1QbJUvr18HYCnt4aS5HEKsTrQMl+NUycTcSCVtaOBrTMgvVXaiS2Dow0b2eT+BBpi+t9hiPigJnYOtVW8kHPywk8CTqf8UCFj0UzDfsWmepLWM5VVGe4DHiPGVLgPovYX0Q75ZZvBhyLmqgp9IpBJVUooBaXxn9Cyj3kVTdoawpy8TQXZYOYsEy2gUUbotU4IERreYwh2cNFUC9ZfUclmwVLXqUbGVpNbATn4r/A9XN0hDGnVhMZ0XJ5jhha2iua3W6q/YC3aXDeHmq85Qtgd+7sBXd0+FQV8gzIjbGLq0ul1zMk9tSOBnrAlP11YXYY7C8gkf0h20F6da6VU7TCNLCXDzzidlYnvlEMsIy4j9pEpPV3qlIzEvKw8S7GK2LggS0YOjzl28S2kvcIQeLWoKQiHek3sUy/W1iWt/zeb0+i743hwqGoVBntfw8deZjwY9R5hIai6KcvEYr/Zgll463tX4xR8+fvstu2ZXjA91kXG1xeRP6H5RfM1C4oALhXEY0UefRVdGEQ+mh9vCmDFWxgmqiT4l0Uy38BMKLbMzqaq86b/mp7Lwd081i4eO4wjDwcC1wznIdQq9KhaMom1Wdl9fqjJdPWfa0HK+DWeDt1Xmzyxrb/fPceC2LDv8BrOauwuSaQQwAAAAASUVORK5CYII=">
                        </div>
                        <p>Vui lòng <a onclick="location.href='/login'">Đăng nhập</a> hoặc <a onclick="location.href='/signup'">Đăng kí</a> để xem giỏ hàng.</p>
                    </div>
                </div>
            <% } else {%>
                <% if (sps.length > 0) { %>
                    <form action="/giohang" method="POST" class="cart_form">
                        <table class="cart_table">
                            <thead class="cart_row cart_header-lables">
                                <tr>
                                    <th colspan="2" class="text-center">Sản phẩm</th>
                                    <th class="text-center">Đơn giá</th>
                                    <th class="text-center">Số lượng</th>
                                    <th class="text-right">Tổng giá</th>
                                </tr>
                            </thead>
                            <% sps.forEach(sp => { %>
                                <tbody>
                                    <tr class="cart_row table_section">
                                        <td data-lable="Sản phẩm">
                                            <a class="cart_image" href="/main/<%= sp.id%>">
                                                <img src="<%= sp.img_small2 %>" alt="<%= sp.tensach %>">
                                            </a>
                                        </td>
                                        <td>
                                            <a class="h4" href="/main/<%= sp.id%>"><%= sp.tensach %></a>
                                            Khuyến mãi: CTDDEAL - Giảm vô thời hạn 10% cho toàn bộ Sách <br>
                                            <a class="cart_remove" data-doc="<%= sp.masp %>">Xóa</a>                                            
                                        </td>
                                        <td data-label="Đơn giá">
                                            <span class="dongia" id="dongia<%=sp.masp%>" ><%= sp.giagiam %></span>
                                        </td>
                                        <td data-label="Số lượng" data-max="0">
                                            <div class="sl_box">
                                                <a class="sub" onclick="decreaseQuantity('<%=sp.masp%>')">&#8722;</a>
                                                <input class="so" id="so<%=sp.masp%>" name="<%=sp.masp%>" maxvalue="999" minvalue="1" align="center" value="<%= sp.sl %>">
                                                <a class="add" onclick="increaseQuantity('<%=sp.masp%>')">&#43;</a>
                                            </div>
                                        </td>
                                        <td data-label="Tổng tiền" class="text-right">
                                            <span class="h3" id="tongtien<%=sp.masp%>"></span>
                                        </td>
                                    </tr>
                                </tbody>
                                <script>
                                    var dongia = document.querySelector('#dongia<%=sp.masp%>').innerText;
                                    dongia = parseFloat(dongia.replace(/[^\d.]/g, ''));
                                    var sl = document.querySelector('#so<%=sp.masp%>').value;
                                    sl = parseInt(sl);
                                    var tong = dongia * 1000 * sl;
                                    tong = tong.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                                    document.querySelector('#tongtien<%=sp.masp%>').innerText = tong;
                                </script>
                            <% }) %>
                        </table>
                        <div class="grid cart_row">
                            <div class="grid_item text-right right">
                                <p>
                                    <span class="cart_subtotal-title">Tạm tính</span>
                                    <span class="cart_subtotal" id="tamtinh"></span>
                                    <script>
                                        var totalElements = document.querySelectorAll('.h3');
                                        var total = 0;
                                        totalElements.forEach(function(element) {
                                            // Lấy giá trị tổng tiền từ từng sản phẩm
                                            var tong = element.innerText;
                                            tong = parseInt(tong.replace(/[^\d]/g, ''), 10);
                                            // Cộng vào tổng tiền chung
                                            total += tong;
                                        });
                                        total = total.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
                                        document.getElementById("tamtinh").innerText = total;
                                    </script>
                                </p>
                                <button type="submit" class="btn-cart">Cập nhật</button>
                                <button type="button"class="btn-cart" onclick="location.href='/thanhtoan'">Thanh toán</button>
                            </div>
                        </div>
                    </form>    
                <% } %>
            <% } %>
        </div>
        
        <!--Script tăng/giảm số lượng-->
        <script>
            function increaseQuantity(masp) {
              var inputElement = document.getElementById("so" + masp);
              var currentValue = parseInt(inputElement.value, 10);
              if (currentValue < 999) {
                inputElement.value = currentValue + 1;
              }
            }
          
            function decreaseQuantity(masp) {
              var inputElement = document.getElementById("so" + masp);
              var currentValue = parseInt(inputElement.value, 10);
              if (currentValue > 1) {
                inputElement.value = currentValue - 1;
              }
            }
        </script>
        <!--Script xóa sp-->
        <script>
            // Sử dụng querySelectorAll để lấy tất cả các phần tử có class là 'cart_remove'
            document.querySelectorAll('.cart_remove').forEach((button) => {
            // Thêm sự kiện click cho mỗi nút xóa
            button.addEventListener('click', (e) => {
                e.preventDefault();
                // Lấy giá trị data-doc từ thuộc tính dữ liệu
                const docId = button.dataset.doc;
                const endpoint = `/giohang/${docId}`;

                // Gửi yêu cầu DELETE đến server
                fetch(endpoint, {
                method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => window.location.href = data.redirect)
                .catch(err => console.log(err));
            });
            });
        </script>

        <!--footer-->
        <%- include("./partials/footer.ejs") %>
    </body>
</html>